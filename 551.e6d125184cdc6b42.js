"use strict";(self.webpackChunkcytube_replay=self.webpackChunkcytube_replay||[]).push([[551],{6551:(Y,C,d)=>{d.r(C),d.d(C,{IndexModule:()=>Z});var _=d(9808),h=d(5861);class F{constructor(){this.connected=!1,this.rank=-1,this.premissions={addnontemp:0,chat:0,chatclear:2,deletefromchannellib:2,drink:0,exceedmaxitems:2,exceedmaxlength:0,leaderctl:0,oplaylistadd:-1,oplaylistaddlist:0,oplaylistdelete:0,oplaylistjump:0,oplaylistmove:0,oplaylistnext:0,playlistadd:-1,playlistaddcustom:0,playlistaddlist:0,playlistaddlive:0,playlistclear:0,playlistdelete:0,playlistjump:0,playlistlock:2,playlistmove:0,playlistnext:0,playlistshuffle:0,pollctl:0,pollvote:-1,seeplaylist:-1,settemp:0,viewhiddenpoll:1.5,viewvoteskip:1.5,voteskip:-1},this.playlistLocked=!1,this.emotes=[],this.drinkCount=0,this.channelCSSJS={css:"",cssHash:"1B2M2Y8AsgTpgAmY7PhCfg==",js:"",jsHash:"1B2M2Y8AsgTpgAmY7PhCfg=="},this.motd="",this.chanelOpts={afk_timeout:600,allow_ascii_control:!1,allow_dupes:!1,allow_voteskip:!0,block_anonymous_users:!1,chat_antiflood:!1,chat_antiflood_params:{burst:4,sustained:1,cooldown:4},enable_link_regex:!0,externalcss:"",externaljs:"",maxlength:0,new_user_chat_delay:0,new_user_chat_link_delay:0,pagetitle:"replay",password:!1,playlist_max_duration_per_user:0,playlist_max_per_user:0,show_public:!1,torbanned:!1},this.playlistMeta={count:0,rawTime:0,time:"00:00"},this.playlist=[],this.userlist=[],this.usercount=0,this.chat=[],this.listPlaylists=[],this.polls=[]}processEvent(l){let t=[];null==l&&(l={type:"unknownEvent",time:0,data:[]}),t.push(l),null==l.data&&(l.data=[]),"string"!=typeof l.type&&(l.type="unknownEvent"),l.data instanceof Array||(l.data=[l.data]);let e=l.data[0];try{switch(l.type){case"connect":this.connected=!0;break;case"rank":this.rank=e;break;case"setPermissions":this.premissions=e;break;case"setPlaylistLocked":this.playlistLocked=e;break;case"emoteList":this.emotes=e;break;case"drinkCount":this.drinkCount=e;break;case"channelCSSJS":this.channelCSSJS=e;break;case"setMotd":this.motd=e;break;case"channelOpts":this.chanelOpts=e;break;case"setPlaylistMeta":this.playlistMeta=e;break;case"playlist":this.playlist=e;break;case"userlist":this.userlist=e;break;case"usercount":this.usercount=e;break;case"login":this.login=e;break;case"chatMsg":this.chat.length>20&&this.chat.splice(0,1),this.chat.push(e);break;case"setCurrent":this.current=e;break;case"changeMedia":this.currentMedia=e;break;case"listPlaylists":this.listPlaylists=e;break;case"delete":let s=e,i=this.playlist.findIndex(a=>a.uid===s.uid);-1!==i&&this.playlist.splice(i,1);break;case"mediaUpdate":let o=e;null!=this.currentMedia&&(this.currentMedia.paused=o.paused,this.currentMedia.currentTime=o.currentTime);break;case"addUser":let n=e,p=this.userlist.findIndex(a=>a.name.toLowerCase()===n.name.toLowerCase());-1!==p?this.userlist[p]=n:this.userlist.push(n);break;case"setUserMeta":let c=e,u=this.userlist.find(a=>a.name.toLowerCase()===c.name.toLowerCase());null!=u&&(u.meta=c.meta);break;case"setAFK":let f=e,m=this.userlist.find(a=>a.name.toLowerCase()===f.name.toLowerCase());null!=m&&(m.meta.afk=f.afk);break;case"setUserRank":let v=e,x=this.userlist.find(a=>a.name.toLowerCase()===v.name.toLowerCase());null!=x&&(x.rank=v.rank);break;case"userLeave":let j=e,M=this.userlist.findIndex(a=>a.name.toLowerCase()===j.name.toLowerCase());-1!==M&&this.userlist.splice(M,1);break;case"clearVoteskipVote":this.voteskip=void 0;break;case"newPoll":this.polls.push(e);break;case"updatePoll":this.polls.length>0&&(this.polls[this.polls.length-1]=e);break;case"queue":let k,g=e;"number"==typeof g.after?k=this.playlist.findIndex(a=>a.uid===g.after)+1:"append"===g.after?k=this.playlist.length:"prepend"===g.after&&(k=0),null!=k&&this.playlist.splice(k,0,g.item);break;case"closePoll":console.log("TODO: closePoll");break;case"announcement":this.announcement=e;break;case"disconnect":this.connected=!1;break;case"moveVideo":let I,b=e,w=this.playlist.findIndex(a=>a.uid===b.from);"number"==typeof b.after?I=this.playlist.findIndex(a=>a.uid===b.after)+1:"append"===b.after?I=this.playlist.length:"prepend"===b.after&&(I=0),null!=I&&null!=w&&-1!==w&&(this.playlist.splice(I,0,this.playlist[w]),this.playlist.splice(w,1));break;case"removeEmote":let W=e,T=this.emotes.findIndex(a=>a.name===W.name);-1!==T&&this.emotes.splice(T,1);break;case"updateEmote":let P=e,S=this.emotes.findIndex(a=>a.name===P.name);-1!==S&&(this.emotes[S]=P);break;case"setLeader":this.leader=e;break;case"setUserProfile":let L=e,O=this.userlist.find(a=>a.name.toLowerCase()===L.name.toLowerCase());null!=O&&(O.profile=L.profile);break;case"kick":this.kicked=e;break;case"partitionChange":console.log("TODO: partitionChange");break;case"voteskip":this.voteskip=e;break;case"setTemp":let E=e,D=this.playlist.find(a=>a.uid===E.uid);null!=D&&(D.temp=E.temp)}}catch(s){}return t}}var U=d(594),y=d(5e3),X=d(9757);let A=(()=>{class r{constructor(t){this.navItems=t,this.frameLoading=!1,this.frameBaseSrc="./assets",this.frameFakeConsoleLog=!1,this.playing=!1,this.currentI=0,this.timeOffset=0,this.remainingDelay=0,this.speedX=1,this.cancelDelay=this.noop=()=>{},this.frameMessage=e=>{var s;"object"==typeof(null===(s=null==e?void 0:e.data)||void 0===s?void 0:s.replayPostMessage)&&this.receiveMessage(e.data.replayPostMessage)},this.navItems.disableAll()}sendMessage(t){null!=this.frameWin&&null!=this.frameOrigin&&this.frameWin.postMessage({replayPostMessage:t},this.frameOrigin)}receiveMessage(t){console.log("msg",t)}ngOnInit(){this.frame=document.getElementById("replay-frame"),this.navItems.disableAllExcept([this.navItems.fileList,this.navItems.fileSelect]),null!=this.navItems.fileList.selected&&this.changeFile(this.navItems.fileList.selected),this.selectedFileSubscription=this.navItems.fileList.selectedChanges.subscribe(t=>{this.changeFile(t)}),this.speedXSubscription=this.navItems.speedX.valueChanges.subscribe(t=>{this.changeSpeedX(t)})}changeSpeedX(t){var e=this;return(0,h.Z)(function*(){e.playing&&(yield e.pause(!0),e.play(!0)),e.sendMessage({type:"replaySpeedXChange",speedX:t})})()}ngOnDestroy(){this.playing&&this.pause(),this.unsubFromEvents(),this.navItems.skipTo.file=void 0}unsubFromEvents(){var t,e,s,i;null===(t=this.selectedFileSubscription)||void 0===t||t.unsubscribe(),null===(e=this.playPauseSubscription)||void 0===e||e.unsubscribe(),null===(s=this.speedXSubscription)||void 0===s||s.unsubscribe(),null===(i=this.skipToSubscription)||void 0===i||i.unsubscribe()}changeFile(t){var e=this;return(0,h.Z)(function*(){var s;if(!e.frameLoading)try{e.playing&&e.pause(),e.currentI=0,e.timeOffset=0,e.remainingDelay=0,e.speedX=1,e.replayState=new F;let i=function R(r,l){let t="1";return r===U.T.CyTube&&(l>1644158271e3?t="3":l>1643263187e3&&(t="2")),t}(t.site,t.start),o=[t.channelPath,t.channelName,e.frameFakeConsoleLog?1:0,window.location.origin],n=JSON.stringify(o);n="#"+encodeURIComponent(n.substr(1,n.length-2)),e.navItems.loading.enabled=!0,e.navItems.loading.text=t.name,e.navItems.hideAllExcept([e.navItems.loading]),e.frameWin=yield e.loadReplayFrame(e.frameBaseSrc+"/"+t.site+"-iframe/v"+i+"-page.html?_"+Date.now()+n),null===(s=e.playPauseSubscription)||void 0===s||s.unsubscribe(),e.playPauseSubscription=e.navItems.playPause.clicked.subscribe(p=>{e.playing?e.pause():e.play()}),e.navItems.skipTo.file=t,e.navItems.skipTo.currentI=e.currentI,e.skipToSubscription=e.navItems.skipTo.selectedChanges.subscribe(p=>{e.changeSkipTo(p)}),e.navItems.disableAllExcept([e.navItems.playPause,e.navItems.skipTo,e.navItems.speedX,e.navItems.fileList,e.navItems.fileSelect]),e.navItems.showAll(),e.file=t}catch(i){console.log("Change file error:",i)}})()}changeSkipTo(t){console.log("skip to")}pause(t=!1){var e=this;return(0,h.Z)(function*(){null!=e.file&&e.playing&&(e.playing=!1,t||(e.navItems.playPause.paused=!0,e.sendMessage({type:"replayPausedChange",paused:!0})),e.cancelDelay(),yield e.playThreadPromise)})()}play(t=!1){null!=this.file&&!this.playing&&(this.timeOffset=Date.now()+this.remainingDelay-this.file.events[this.currentI].time,this.playing=!0,t||(this.navItems.playPause.paused=!1,this.sendMessage({type:"replayPausedChange",paused:!1})),(this.playThreadPromise=this.playThread()).then(()=>{this.playThreadPromise=void 0}))}playThread(){var t=this;return(0,h.Z)(function*(){if(null!=t.file&&null!=t.replayState){console.log("playThread started");let e=!1;for(let s=t.currentI;s<t.file.events.length&&!e;s++){t.currentI=s;let i=t.file.events[s],n=i.time+t.timeOffset-Date.now();1!=t.speedX&&(t.timeOffset-=n-Math.floor(n/t.speedX),n=Math.floor(n/t.speedX)),e=!(yield t.delay(n)),e||(t.navItems.skipTo.currentI=s,t.replayState.processEvent(i),"function"==typeof globalThis.replayEventHook&&globalThis.replayEventHook(t,i),t.sendMessage({type:"replayEvent",key:i.type,data:i.data}))}console.log("playThread stopped")}})()}delay(t){var e=this;return(0,h.Z)(function*(){return yield new Promise(s=>{let i=Date.now()+t,o=window.setTimeout(()=>{e.remainingDelay=0,e.cancelDelay=e.noop,s(!0)},t);e.cancelDelay=()=>{e.remainingDelay=i-Date.now(),window.clearTimeout(o),e.cancelDelay=e.noop,s(!1)}})})()}loadReplayFrame(t){var e=this;return(0,h.Z)(function*(){return yield new Promise((s,i)=>{const o="Replay frame content window is null";e.frameLoading=!0;let p=window.setTimeout(()=>{i(new Error("Replay frame load timed out. (No response)"))},5e3);window.onmessage=c=>{var u,f,m;if("object"==typeof(null===(u=null==c?void 0:c.data)||void 0===u?void 0:u.replayPostMessage)){let v=c.data.replayPostMessage;"replayWindowLoaded"===v.type&&(null==(null===(f=e.frame)||void 0===f?void 0:f.contentWindow)?i(new Error(o)):(clearTimeout(p),e.frameLoading=!1,e.frameOrigin=v.origin,window.onmessage=e.frameMessage,s(null===(m=e.frame)||void 0===m?void 0:m.contentWindow)))}},null==e.frame?i(new Error(o)):e.frame.src=t})})()}get speedX(){return this.navItems.speedX.value}set speedX(t){this.navItems.speedX.value=t}}return r.\u0275fac=function(t){return new(t||r)(y.Y36(X.Y))},r.\u0275cmp=y.Xpm({type:r,selectors:[["app-index"]],decls:1,vars:0,consts:[["id","replay-frame"]],template:function(t,e){1&t&&y._UZ(0,"iframe",0)},styles:["[_nghost-%COMP%]{flex:1;display:flex}#replay-frame[_ngcontent-%COMP%]{border:0}#replay-frame[_ngcontent-%COMP%]:not([src]){width:0;height:0}#replay-frame[src][_ngcontent-%COMP%]{flex:1}"]}),r})();var B=d(5834);const V=[{path:"",component:A}];let Z=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=y.oAB({type:r}),r.\u0275inj=y.cJS({imports:[[_.ez,B.Bz.forChild(V)]]}),r})()}}]);