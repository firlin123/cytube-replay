"use strict";(self.webpackChunkcytube_replay=self.webpackChunkcytube_replay||[]).push([[895],{5895:(N,C,c)=>{c.r(C),c.d(C,{IndexModule:()=>W});var P=c(9808),p=c(5861);class D{constructor(){this.connected=!1,this.rank=-1,this.premissions={addnontemp:0,chat:0,chatclear:2,deletefromchannellib:2,drink:0,exceedmaxitems:2,exceedmaxlength:0,leaderctl:0,oplaylistadd:-1,oplaylistaddlist:0,oplaylistdelete:0,oplaylistjump:0,oplaylistmove:0,oplaylistnext:0,playlistadd:-1,playlistaddcustom:0,playlistaddlist:0,playlistaddlive:0,playlistclear:0,playlistdelete:0,playlistjump:0,playlistlock:2,playlistmove:0,playlistnext:0,playlistshuffle:0,pollctl:0,pollvote:-1,seeplaylist:-1,settemp:0,viewhiddenpoll:1.5,viewvoteskip:1.5,voteskip:-1},this.playlistLocked=!1,this.emotes=[],this.drinkCount=0,this.channelCSSJS={css:"",cssHash:"1B2M2Y8AsgTpgAmY7PhCfg==",js:"",jsHash:"1B2M2Y8AsgTpgAmY7PhCfg=="},this.motd="",this.chanelOpts={afk_timeout:600,allow_ascii_control:!1,allow_dupes:!1,allow_voteskip:!0,block_anonymous_users:!1,chat_antiflood:!1,chat_antiflood_params:{burst:4,sustained:1,cooldown:4},enable_link_regex:!0,externalcss:"",externaljs:"",maxlength:0,new_user_chat_delay:0,new_user_chat_link_delay:0,pagetitle:"replay",password:!1,playlist_max_duration_per_user:0,playlist_max_per_user:0,show_public:!1,torbanned:!1},this.playlistMeta={count:0,rawTime:0,time:"00:00"},this.playlist=[],this.userlist=[],this.usercount=0,this.chat=[],this.listPlaylists=[],this.polls=[]}processEvent(i){let e=i.data[0];try{switch(i.type){case"connect":this.connected=!0;break;case"rank":this.rank=e;break;case"setPermissions":this.premissions=e;break;case"setPlaylistLocked":this.playlistLocked=e;break;case"emoteList":this.emotes=e;break;case"drinkCount":this.drinkCount=e;break;case"channelCSSJS":this.channelCSSJS=e;break;case"setMotd":this.motd=e;break;case"channelOpts":this.chanelOpts=e;break;case"setPlaylistMeta":this.playlistMeta=e;break;case"playlist":this.playlist=e;break;case"userlist":this.userlist=e;break;case"usercount":this.usercount=e;break;case"login":this.login=e;break;case"chatMsg":this.chat.length>20&&this.chat.splice(0,1),this.chat.push(e);break;case"setCurrent":this.current=e;break;case"changeMedia":this.currentMedia=e;break;case"listPlaylists":this.listPlaylists=e;break;case"delete":let t=e,s=this.playlist.findIndex(o=>o.uid===t.uid);-1!==s&&this.playlist.splice(s,1);break;case"mediaUpdate":let l=e;null!=this.currentMedia&&(this.currentMedia.paused=l.paused,this.currentMedia.currentTime=l.currentTime);break;case"addUser":let n=e,r=this.userlist.findIndex(o=>o.name.toLowerCase()===n.name.toLowerCase());-1!==r?this.userlist[r]=n:this.userlist.push(n);break;case"setUserMeta":let m=e,u=this.userlist.find(o=>o.name.toLowerCase()===m.name.toLowerCase());null!=u&&(u.meta=m.meta);break;case"setAFK":let k=e,h=this.userlist.find(o=>o.name.toLowerCase()===k.name.toLowerCase());null!=h&&(h.meta.afk=k.afk);break;case"setUserRank":let T=e,I=this.userlist.find(o=>o.name.toLowerCase()===T.name.toLowerCase());null!=I&&(I.rank=T.rank);break;case"userLeave":let B=e,M=this.userlist.findIndex(o=>o.name.toLowerCase()===B.name.toLowerCase());-1!==M&&this.userlist.splice(M,1);break;case"clearVoteskipVote":this.voteskip=void 0;break;case"newPoll":this.polls.push(e);break;case"updatePoll":this.polls.length>0&&(this.polls[this.polls.length-1]=e);break;case"queue":let y,f=e;"number"==typeof f.after?y=this.playlist.findIndex(o=>o.uid===f.after)+1:"append"===f.after?y=this.playlist.length:"prepend"===f.after&&(y=0),null!=y&&this.playlist.splice(y,0,f.item);break;case"closePoll":console.log("TODO: closePoll");break;case"announcement":this.announcement=e;break;case"disconnect":this.connected=!1;break;case"moveVideo":let g,v=e,b=this.playlist.findIndex(o=>o.uid===v.from);"number"==typeof v.after?g=this.playlist.findIndex(o=>o.uid===v.after)+1:"append"===v.after?g=this.playlist.length:"prepend"===v.after&&(g=0),null!=g&&null!=b&&-1!==b&&(this.playlist.splice(g,0,this.playlist[b]),this.playlist.splice(b,1));break;case"removeEmote":let H=e,L=this.emotes.findIndex(o=>o.name===H.name);-1!==L&&this.emotes.splice(L,1);break;case"updateEmote":let x=e,S=this.emotes.findIndex(o=>o.name===x.name);-1!==S&&(this.emotes[S]=x);break;case"setLeader":this.leader=e;break;case"setUserProfile":let O=e,_=this.userlist.find(o=>o.name.toLowerCase()===O.name.toLowerCase());null!=_&&(_.profile=O.profile);break;case"kick":this.kicked=e;break;case"partitionChange":console.log("TODO: partitionChange");break;case"voteskip":this.voteskip=e;break;case"setTemp":let U=e,R=this.playlist.find(o=>o.uid===U.uid);null!=R&&(R.temp=U.temp)}}catch(t){}}prepareFile(i,e){return(0,p.Z)(function*(){let t=JSON.parse(JSON.stringify(i));for(let s=0;s<t.events.length;s++){let l;if(l=null==t.events[s]?t.events[s]={type:"unknownEvent",time:0,data:[]}:t.events[s],null==l.data&&(l.data=[]),"string"!=typeof l.type&&(l.type="unknownEvent"),l.data instanceof Array||(l.data=[l.data]),"changeMedia"===l.type){let n=l.data[0];if("cm"===n.type){e.text=n.title,console.log("Loading",n.title,n.id);try{let r=yield fetch(n.id);if(r.ok){let m=yield r.json();n.meta.direct={},m.sources.map(u=>{n.meta.direct[u.quality]=[{contentType:u.contentType,link:u.url,quality:u.quality}]})}}catch(r){console.error(r)}}}}return t})()}}var d=c(5e3),E=c(594);class w{constructor(){this.frame=null,this.window=null,this.resolveFramePromise=null,this.framePromise=new Promise(i=>{this.resolveFramePromise=e=>i(e)}),this.messageReceived=new d.vpe,window.addEventListener("message",i=>{console.log("msg",i),this.messageReceived.emit(i)})}set frameComponent(i){if(this.frame=i,null!=i){if(null!=this.resolveFramePromise){let e=this.resolveFramePromise;this.resolveFramePromise=null,e(i)}}else this.window=null}loadUrl(i,e=!0){var t=this;return(0,p.Z)(function*(){var s;let l=null!==(s=t.frame)&&void 0!==s?s:yield t.framePromise;t.window=yield l.loadUrl(i,e)})()}sendMessage(i,e){null!=this.window&&this.window.postMessage(i,e)}}class X extends w{constructor(i){super(),this.frameFakeConsoleLog=i,this.replayFrameLoaded=!1,this.origin=null,this.resolveReplayFrameOriginPromise=null,this.replayMessageReceived=new d.vpe,this.messageReceived.subscribe(e=>{var t;if("object"==typeof(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.replayPostMessage)){let s=e.data.replayPostMessage;if("replayWindowLoaded"===s.type&&null!=this.resolveReplayFrameOriginPromise){let l=this.resolveReplayFrameOriginPromise;this.resolveReplayFrameOriginPromise=null,l(s.origin)}else this.replayMessageReceived.emit(s)}})}loadReplayFrame(i){var e=this;return(0,p.Z)(function*(){let t=e.getPageVersion(i.site,i.start),s=[i.channelPath,i.channelName,e.frameFakeConsoleLog?1:0,window.location.origin],l=JSON.stringify(s);l="#"+encodeURIComponent(l.substr(1,l.length-2));let n=new Promise(r=>{e.resolveReplayFrameOriginPromise=m=>r(m)});yield e.loadUrl("assets/"+i.site+"-iframe/v"+t+"-page.html?_"+Date.now()+l),e.origin=yield n})()}getPageVersion(i,e){let t="1";return i===E.T.CyTube&&(e>1645362602e3?t="4":e>1644158271e3?t="3":e>1643263187e3&&(t="2")),t}sendReplayMessage(i){null!=this.origin&&this.sendMessage({replayPostMessage:i},this.origin)}}class F{constructor(){this.cancelDelay=null,this.cancelled=!1,this.remaining=0}cancel(){null!=this.cancelDelay&&this.cancelDelay()}start(i){var e=this;return(0,p.Z)(function*(){e.cancelDelay=null,e.cancelled=!1,e.remaining=0;let t=Date.now();return yield new Promise(s=>{let l=window.setTimeout(()=>s(),i);e.cancelDelay=()=>{window.clearTimeout(l);let n=i-(Date.now()-t);e.remaining=n<0?0:n,e.cancelled=!0,e.cancelDelay=null,s()}}),e.cancelled})()}}var Z=c(9757);let A=(()=>{class a{constructor(e){this.location=e,this.frame=null,this.myFrameControl=null,this.resolveLoadingUrlPromise=null,this.loadingUrlPromise=null,this.resolveLoadingFramePromise=null,this.loadingFramePromise=new Promise(t=>{this.resolveLoadingFramePromise=s=>t(s)})}ngOnDestroy(){null!=this.myFrameControl&&(this.myFrameControl.frameComponent=null)}ngOnChanges(e){if("myFrameControl"in e){let t=e.myFrameControl;t.previousValue instanceof w&&(t.previousValue.frameComponent=null),t.currentValue.frameComponent=this}}ngOnInit(){}onLoadFrame(e){null!=e&&(null==this.frame?(this.frame=e,null!=this.resolveLoadingFramePromise&&this.resolveLoadingFramePromise(e)):null!=e.contentWindow&&this.onLoadWindow(e.contentWindow))}onLoadWindow(e){if(null!=this.resolveLoadingUrlPromise){let t=this.resolveLoadingUrlPromise;this.resolveLoadingUrlPromise=null,t(e)}}loadUrl(e,t=!0){var s=this;return(0,p.Z)(function*(){let l=t?s.location.prepareExternalUrl(e):e,n=s.loadingUrlPromise;return s.loadingUrlPromise=new Promise(function(){var r=(0,p.Z)(function*(m){var u;null!=n&&(yield n);let k=null!==(u=s.frame)&&void 0!==u?u:yield s.loadingFramePromise;s.resolveLoadingUrlPromise=h=>m(h),k.src=l});return function(m){return r.apply(this,arguments)}}()),yield s.loadingUrlPromise})()}}return a.\u0275fac=function(e){return new(e||a)(d.Y36(P.Ye))},a.\u0275cmp=d.Xpm({type:a,selectors:[["app-my-frame"]],inputs:{myFrameControl:"myFrameControl"},features:[d.TTD],decls:2,vars:0,consts:[[3,"load"],["myFrame",""]],template:function(e,t){if(1&e){const s=d.EpF();d.TgZ(0,"iframe",0,1),d.NdJ("load",function(){d.CHM(s);const n=d.MAs(1);return t.onLoadFrame(n)}),d.qZA()}},styles:["iframe[_ngcontent-%COMP%]{border:0;width:100%;height:100%}"]}),a})(),V=(()=>{class a{constructor(e){this.navItems=e,this.skipOffset=0,this.fileLoadPromise=null,this.delay=new F,this.playing=!1,this.currentI=0,this.timeOffset=0,this.speedX=1,this.navItems.hideAll(),this.frameControl=new X(!1),this.frameControl.replayMessageReceived.subscribe(t=>{console.log("msg",t)})}ngOnInit(){this.navItems.hideAllExcept([this.navItems.fileList,this.navItems.fileSelect]),null!=this.navItems.fileList.selected&&this.changeFile(this.navItems.fileList.selected),this.selectedFileSubscription=this.navItems.fileList.selectedChanges.subscribe(e=>{this.changeFile(e)}),this.speedXSubscription=this.navItems.speedX.valueChanges.subscribe(e=>{this.changeSpeedX(e)})}changeSpeedX(e){var t=this;return(0,p.Z)(function*(){t.playing&&(yield t.pause(!1),t.play(!1)),t.frameControl.sendReplayMessage({type:"replaySpeedXChange",speedX:e})})()}ngOnDestroy(){this.playing&&this.pause(),this.unsubFromEvents(),this.navItems.skipTo.file=void 0}unsubFromEvents(){var e,t,s,l,n;null===(e=this.selectedFileSubscription)||void 0===e||e.unsubscribe(),null===(t=this.playPauseSubscription)||void 0===t||t.unsubscribe(),null===(s=this.speedXSubscription)||void 0===s||s.unsubscribe(),null===(l=this.skipToTimeSubscription)||void 0===l||l.unsubscribe(),null===(n=this.skipToCustomTimeSubscription)||void 0===n||n.unsubscribe()}changeFile(e){var t=this;return(0,p.Z)(function*(){let s=t.fileLoadPromise;t.fileLoadPromise=new Promise(function(){var l=(0,p.Z)(function*(n){null!=s&&(yield s);try{t.playing&&(yield t.pause()),t.skipOffset=0,t.currentI=0,t.timeOffset=0,t.delay=new F,t.speedX=1,t.replayState=new D,t.navItems.loadingPreset(e.name),e=yield t.replayState.prepareFile(e,t.navItems.loading),yield t.frameControl.loadReplayFrame(e),null==t.playPauseSubscription&&(t.playPauseSubscription=t.navItems.playPause.clicked.subscribe(r=>{t.playing?t.pause():t.play()})),t.navItems.skipTo.file=e,t.navItems.skipTo.currentI=t.currentI,null==t.skipToTimeSubscription&&(t.skipToTimeSubscription=t.navItems.skipTo.skipToTimeChanges.subscribe(r=>{t.skipToTime(r)})),null==t.skipToCustomTimeSubscription&&(t.skipToCustomTimeSubscription=t.navItems.skipTo.skipCustomTimeChanges.subscribe(r=>{t.skipCustomTime(r)})),t.navItems.mainPreset(),t.file=e}catch(r){console.log("Change file error:",r)}n()});return function(n){return l.apply(this,arguments)}}()),yield t.fileLoadPromise})()}skipToTime(e){var t=this;return(0,p.Z)(function*(){null!=t.file&&(console.log("skip to",e),yield t.setSkipOffset(e-t.file.events[t.currentI].time))})()}skipCustomTime(e){var t=this;return(0,p.Z)(function*(){null!=t.file&&(console.log("skip for",e),yield t.setSkipOffset(e))})()}setSkipOffset(e){var t=this;return(0,p.Z)(function*(){let s=t.playing;t.playing&&(yield t.pause(!1)),t.skipOffset=e,s&&t.play(!1)})()}pause(e=!0){var t=this;return(0,p.Z)(function*(){null!=t.file&&t.playing&&(t.playing=!1,e&&(t.navItems.playPause.paused=!0,t.frameControl.sendReplayMessage({type:"replayPausedChange",paused:!0})),t.delay.cancel(),yield t.playThreadPromise)})()}play(e=!0){let t=0;this.skipOffset>0&&(t=this.skipOffset,this.skipOffset=0),null!=this.file&&!this.playing&&(this.timeOffset=Date.now()+this.delay.remaining-this.file.events[this.currentI].time-t,this.playing=!0,e&&(this.navItems.playPause.paused=!1,this.frameControl.sendReplayMessage({type:"replayPausedChange",paused:!1})),(this.playThreadPromise=this.playThread(0!==t)).then(()=>{this.playThreadPromise=void 0}))}playThread(e=!1){var t=this;return(0,p.Z)(function*(){if(null!=t.file&&null!=t.replayState){console.log("playThread started");for(let s=t.currentI;s<t.file.events.length;s++){t.currentI=s;let l=t.file.events[s],r=l.time+t.timeOffset-Date.now();if(r>0&&e&&(e=!1,console.log("Skipping done")),1!=t.speedX&&(t.timeOffset-=r-Math.floor(r/t.speedX),r=Math.floor(r/t.speedX)),yield t.delay.start(r),t.delay.cancelled)break;t.navItems.skipTo.currentI=s,t.replayState.processEvent(l),"function"==typeof globalThis.replayEventHook&&globalThis.replayEventHook(t,l),t.frameControl.sendReplayMessage({type:"replayEvent",key:l.type,data:l.data})}console.log("playThread stopped")}})()}get speedX(){return this.navItems.speedX.value}set speedX(e){this.navItems.speedX.value=e}}return a.\u0275fac=function(e){return new(e||a)(d.Y36(Z.Y))},a.\u0275cmp=d.Xpm({type:a,selectors:[["app-index"]],decls:1,vars:1,consts:[[3,"myFrameControl"]],template:function(e,t){1&e&&d._UZ(0,"app-my-frame",0),2&e&&d.Q6J("myFrameControl",t.frameControl)},directives:[A],styles:["[_nghost-%COMP%]{flex:1;display:flex}app-my-frame[_ngcontent-%COMP%]{flex:1}"]}),a})();var j=c(5834);let J=(()=>{class a{}return a.\u0275fac=function(e){return new(e||a)},a.\u0275mod=d.oAB({type:a}),a.\u0275inj=d.cJS({imports:[[P.ez]]}),a})();const Y=[{path:"",component:V}];let W=(()=>{class a{}return a.\u0275fac=function(e){return new(e||a)},a.\u0275mod=d.oAB({type:a}),a.\u0275inj=d.cJS({imports:[[P.ez,j.Bz.forChild(Y),J]]}),a})()}}]);