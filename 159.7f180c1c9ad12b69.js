"use strict";(self.webpackChunkcytube_replay=self.webpackChunkcytube_replay||[]).push([[159],{6159:(x,h,l)=>{l.r(h),l.d(h,{IndexModule:()=>C});var v=l(9808),r=l(5861),o=l(5e3),g=l(9757);let I=(()=>{class n{constructor(t){this.navItems=t,this.frameLoading=!1,this.frameBaseSrc="./assets",this.frameFakeConsoleLog=!1,this.playing=!1,this.currentI=0,this.timeOffset=0,this.remainingDelay=0,this.unsubCallBacks=[],this.speedX=1,this.cancelDelay=this.noop=()=>{},this.frameMessage=e=>{var a;"object"==typeof(null===(a=null==e?void 0:e.data)||void 0===a?void 0:a.replayPostMessage)&&this.receiveMessage(e.data.replayPostMessage)},this.navItems.disableAll()}receiveMessage(t){console.log("msg",t)}ngOnInit(){this.frame=document.getElementById("replay-frame"),this.navItems.disableAllExcept([this.navItems.fileList,this.navItems.fileSelect]),null!=this.navItems.fileList.selected&&this.changeFile(this.navItems.fileList.selected);let t=this.navItems.fileList.selectedChanges.subscribe(e=>{this.changeFile(e)});this.unsubCallBacks.push(()=>{t.unsubscribe()})}ngOnDestroy(){this.playing&&this.pause(),this.unsubFromEvents()}unsubFromEvents(){this.unsubCallBacks.forEach(t=>t())}changeFile(t){var e=this;return(0,r.Z)(function*(){if(!e.frameLoading)try{e.playing&&e.pause();let a=[t.channelPath,t.channelName,e.frameFakeConsoleLog?1:0,window.location.origin],i=JSON.stringify(a);i="#"+encodeURIComponent(i.substr(1,i.length-2)),e.navItems.loading.enabled=!0,e.navItems.loading.text=t.name,e.navItems.hideAllExcept([e.navItems.loading]),e.frameWin=yield e.loadReplayFrame(e.frameBaseSrc+"/cytube_iframe/v2_page.html?_"+Date.now()+i);let s=e.navItems.playPause.clicked.subscribe(p=>{e.playing?e.pause():e.play()});e.unsubCallBacks.push(()=>{s.unsubscribe()}),e.navItems.disableAllExcept([e.navItems.playPause,e.navItems.skipTo,e.navItems.speedX,e.navItems.fileList,e.navItems.fileSelect]),e.navItems.showAllExcept([e.navItems.skipTo]),e.file=t}catch(a){console.log("Change file error:",a)}})()}pause(){null!=this.file&&this.playing&&(this.playing=!1,this.navItems.playPause.paused=!0,this.cancelDelay())}play(){null!=this.file&&!this.playing&&(this.timeOffset=Date.now()+this.remainingDelay-this.file.events[this.currentI].time,this.playing=!0,this.navItems.playPause.paused=!1,this.playThread())}playThread(){var t=this;return(0,r.Z)(function*(){if(null!=t.file)for(let e=t.currentI;e<t.file.events.length&&t.playing;e++){t.currentI=e;let a=t.file.events[e],s=a.time+t.timeOffset-Date.now();1!=t.speedX&&(t.timeOffset-=s-Math.floor(s/t.speedX),s=Math.floor(s/t.speedX)),t.remainingDelay=yield t.delay(s),t.playing&&console.log("ev",e,a,t.remainingDelay,s)}})()}delay(t){var e=this;return(0,r.Z)(function*(){return yield new Promise(a=>{let i=Date.now()+t,s=window.setTimeout(()=>{e.cancelDelay=e.noop,a(0)},t);e.cancelDelay=()=>{window.clearTimeout(s),e.cancelDelay=e.noop,a(i-Date.now())}})})()}loadReplayFrame(t){var e=this;return(0,r.Z)(function*(){return yield new Promise((a,i)=>{const s="Replay frame content window is null";e.frameLoading=!0;let M=window.setTimeout(()=>{i(new Error("Replay frame load timed out. (No response)"))},5e3);window.onmessage=c=>{var d,u,f;if("object"==typeof(null===(d=null==c?void 0:c.data)||void 0===d?void 0:d.replayPostMessage)){let y=c.data.replayPostMessage;"replayWindowLoaded"===y.type&&(null==(null===(u=e.frame)||void 0===u?void 0:u.contentWindow)?i(new Error(s)):(clearTimeout(M),e.frameLoading=!1,e.frameOrigin=y.origin,window.onmessage=e.frameMessage,a(null===(f=e.frame)||void 0===f?void 0:f.contentWindow)))}},null==e.frame?i(new Error(s)):e.frame.src=t})})()}get speedX(){return this.navItems.speedX.value}set speedX(t){this.navItems.speedX.value=t}}return n.\u0275fac=function(t){return new(t||n)(o.Y36(g.Y))},n.\u0275cmp=o.Xpm({type:n,selectors:[["app-index"]],decls:1,vars:0,consts:[["id","replay-frame"]],template:function(t,e){1&t&&o._UZ(0,"iframe",0)},styles:["[_nghost-%COMP%]{flex:1;display:flex}#replay-frame[_ngcontent-%COMP%]{border:0}#replay-frame[_ngcontent-%COMP%]:not([src]){width:0;height:0}#replay-frame[src][_ngcontent-%COMP%]{flex:1}"]}),n})();var w=l(5834);const b=[{path:"",component:I}];let C=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=o.oAB({type:n}),n.\u0275inj=o.cJS({imports:[[v.ez,w.Bz.forChild(b)]]}),n})()}}]);